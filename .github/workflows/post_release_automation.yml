name: Post-Release Automation
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version that was released (e.g., 0.3.0)'
        required: true
      skip_version_bump:
        description: 'Skip version bump to next dev version'
        type: boolean
        default: false
      skip_discussion:
        description: 'Skip GitHub Discussion creation'
        type: boolean
        default: false
      skip_deployment:
        description: 'Skip deployment triggers'
        type: boolean
        default: false
      skip_notifications:
        description: 'Skip notifications'
        type: boolean
        default: false

jobs:
  post-release-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install PyGithub requests python-dotenv
      
      - name: Extract version information
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          fi
          echo "current=$VERSION" >> $GITHUB_OUTPUT
          
          # Calculate next dev version (e.g., 0.3.0 -> 0.3.1.dev0)
          IFS='.' read -r major minor patch <<< "$VERSION"
          patch=$((patch + 1))
          NEXT_DEV_VERSION="${major}.${minor}.${patch}.dev0"
          echo "next_dev=$NEXT_DEV_VERSION" >> $GITHUB_OUTPUT
          
          echo "Current version: $VERSION"
          echo "Next dev version: $NEXT_DEV_VERSION"
      
      - name: Update version to next dev version
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_version_bump))
        run: |
          NEXT_VERSION="${{ steps.version.outputs.next_dev }}"
          
          # Update setup.py
          sed -i "s/version=\"[^\"]*\"/version=\"$NEXT_VERSION\"/" setup.py
          
          # Update neural/__init__.py
          sed -i "s/__version__ = \"[^\"]*\"/__version__ = \"$NEXT_VERSION\"/" neural/__init__.py
          
          echo "âœ“ Updated version to $NEXT_VERSION"
          
          # Show changes
          git diff setup.py neural/__init__.py
      
      - name: Commit version bump
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_version_bump))
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add setup.py neural/__init__.py
          git commit -m "Bump version to ${{ steps.version.outputs.next_dev }} [skip ci]" || true
          git push || true
      
      - name: Create GitHub Discussion announcement
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_discussion))
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/automation/post_release_helper.py \
            --action discussion \
            --version "${{ steps.version.outputs.current }}" || true
      
      - name: Update project documentation links
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_deployment))
        run: |
          VERSION="${{ steps.version.outputs.current }}"
          
          # Update README badges if needed
          if [ -f "README.md" ]; then
            echo "Checking README.md for version references..."
            sed -i "s/neural-dsl-[0-9]\+\.[0-9]\+\.[0-9]\+/neural-dsl-$VERSION/g" README.md || true
          fi
          
          # Update docs/index.md if it exists
          if [ -f "docs/index.md" ]; then
            echo "Updating docs/index.md..."
            sed -i "s/version [0-9]\+\.[0-9]\+\.[0-9]\+/version $VERSION/g" docs/index.md || true
          fi
          
          echo "âœ“ Documentation links updated"
      
      - name: Trigger Netlify deployment
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_deployment)) &&
          secrets.NETLIFY_BUILD_HOOK != ''
        env:
          NETLIFY_BUILD_HOOK: ${{ secrets.NETLIFY_BUILD_HOOK }}
        run: |
          if [ -n "$NETLIFY_BUILD_HOOK" ]; then
            echo "Triggering Netlify deployment..."
            curl -X POST -d {} "$NETLIFY_BUILD_HOOK"
            echo "âœ“ Netlify deployment triggered"
          else
            echo "âš  NETLIFY_BUILD_HOOK not configured, skipping"
          fi
      
      - name: Trigger Vercel deployment
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_deployment)) &&
          secrets.VERCEL_DEPLOY_HOOK != ''
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          if [ -n "$VERCEL_DEPLOY_HOOK" ]; then
            echo "Triggering Vercel deployment..."
            curl -X POST "$VERCEL_DEPLOY_HOOK"
            echo "âœ“ Vercel deployment triggered"
          else
            echo "âš  VERCEL_DEPLOY_HOOK not configured, skipping"
          fi
      
      - name: Send Discord notification
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_notifications)) &&
          secrets.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            VERSION="${{ steps.version.outputs.current }}"
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
            PYPI_URL="https://pypi.org/project/neural-dsl/${VERSION}/"
            
            # Create Discord message payload
            cat > discord_payload.json <<EOL
          {
            "embeds": [{
              "title": "ðŸŽ‰ Neural DSL v${VERSION} Released!",
              "description": "A new version of Neural DSL has been released.",
              "color": 3066993,
              "fields": [
                {
                  "name": "ðŸ“¦ Version",
                  "value": "${VERSION}",
                  "inline": true
                },
                {
                  "name": "ðŸ”— Links",
                  "value": "[GitHub Release](${RELEASE_URL}) â€¢ [PyPI](${PYPI_URL})",
                  "inline": false
                },
                {
                  "name": "ðŸ“¥ Install",
                  "value": "\`\`\`bash\npip install --upgrade neural-dsl\`\`\`",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOL
            
            # Send to Discord
            curl -H "Content-Type: application/json" \
                 -d @discord_payload.json \
                 "$DISCORD_WEBHOOK_URL"
            
            echo "âœ“ Discord notification sent"
          else
            echo "âš  DISCORD_WEBHOOK_URL not configured, skipping"
          fi
      
      - name: Create follow-up issue for next release
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          NEXT_VERSION=$(echo "${{ steps.version.outputs.next_dev }}" | sed 's/\.dev0//')
          python scripts/automation/post_release_helper.py \
            --action issue \
            --version "${{ steps.version.outputs.current }}" \
            --next-version "$NEXT_VERSION" || true
      
      - name: Update GitHub Pages (if applicable)
        if: |
          (github.event_name == 'release' || 
           (github.event_name == 'workflow_dispatch' && !github.event.inputs.skip_deployment))
        run: |
          # Check if gh-pages branch exists
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "GitHub Pages detected, would trigger rebuild..."
            # The actual page rebuild will happen automatically via GitHub Actions
            echo "âœ“ GitHub Pages will rebuild automatically"
          else
            echo "â„¹ No GitHub Pages detected"
          fi
      
      - name: Generate release summary
        if: always()
        run: |
          cat <<'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           Post-Release Automation Complete                     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Released Version: ${{ steps.version.outputs.current }}
          Next Dev Version: ${{ steps.version.outputs.next_dev }}
          
          Tasks Completed:
          âœ“ Version bumped to next dev version
          âœ“ GitHub Discussion announcement prepared
          âœ“ Documentation links updated
          âœ“ Deployment triggers sent (if configured)
          âœ“ Discord notification sent (if configured)
          âœ“ Planning issue created for next release
          
          Next Steps:
          1. Monitor deployment status (Netlify/Vercel)
          2. Check Discord for community response
          3. Review planning issue for next release
          4. Continue development on main branch
          
          EOF
      
      - name: Post summary to job
        if: always()
        run: |
          echo "### Post-Release Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Released Version:** ${{ steps.version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "**Next Dev Version:** ${{ steps.version.outputs.next_dev }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Tasks Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version updated to next dev cycle" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Discussion prepared" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation updated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployments triggered (if configured)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Notifications sent (if configured)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Planning issue created" >> $GITHUB_STEP_SUMMARY
