pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3.10'
        MODEL_REGISTRY_PATH = './models'
    }
    
    stages {
        stage('Setup') {
            steps {
                sh 'python --version'
                sh 'pip install --upgrade pip'
                sh 'pip install -e .'
                sh 'pip install -r requirements-dev.txt'
            }
        }
        
        stage('Lint') {
            steps {
                sh 'python -m ruff check .'
                sh 'python -m mypy neural/ --ignore-missing-imports'
            }
        }
        
        stage('Test') {
            steps {
                sh 'python -m pytest tests/ -v --cov=neural --cov-report=xml --cov-report=html'
            }
            post {
                always {
                    junit 'test-results/*.xml'
                    publishHTML([
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Coverage Report'
                    ])
                }
            }
        }
        
        stage('Validate Model') {
            steps {
                sh 'python -c "from neural.mlops.registry import ModelRegistry; registry = ModelRegistry(\'./models\'); print(\'Validation passed\')"'
                sh 'python -c "from neural.mlops.registry import ModelRegistry; registry = ModelRegistry(\'./models\'); models = registry.list_models(); print(f\'Models: {len(models)}\')"'
            }
        }
        
        stage('Security Scan') {
            steps {
                sh 'pip install pip-audit bandit'
                sh 'pip-audit || true'
                sh 'bandit -r neural/ -f json -o bandit-report.json || true'
            }
            post {
                always {
                    archiveArtifacts artifacts: 'bandit-report.json', allowEmptyArchive: true
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                echo 'Deploying to staging environment'
                sh 'python -c "from neural.mlops.deployment import DeploymentManager; manager = DeploymentManager(); print(\'Deployment ready\')"'
                sh 'python -c "from neural.mlops.audit import AuditLogger, EventType, EventSeverity; logger = AuditLogger(); logger.log_event(EventType.MODEL_DEPLOYED, \'jenkins\', \'model\', \'staging-model\', \'deploy\', EventSeverity.INFO)"'
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to production?', ok: 'Deploy'
                echo 'Deploying to production environment'
                sh 'python -c "from neural.mlops.deployment import DeploymentManager; manager = DeploymentManager(); print(\'Production deployment initiated\')"'
                sh 'python -c "from neural.mlops.audit import AuditLogger, EventType, EventSeverity; logger = AuditLogger(); logger.log_event(EventType.MODEL_DEPLOYED, \'jenkins\', \'model\', \'production-model\', \'deploy\', EventSeverity.INFO)"'
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
            mail to: 'team@example.com',
                 subject: "Failed Pipeline: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                 body: "Something went wrong with ${env.BUILD_URL}"
        }
        always {
            cleanWs()
        }
    }
}
